name: Generate Resume PDF

on:
  push:
    branches: [main, master]
    paths:
      - "resume.html"

jobs:
  generate-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: Install dependencies
        run: |
          npm install puppeteer
          npm install -g @puppeteer/headless-chrome-pdf

      - name: Create PDF directory if it doesn't exist
        run: mkdir -p assets/pdf

      - name: Generate PDF from HTML
        run: |
          # Create a script to generate a PDF
          cat > generate-pdf.js << 'EOL'
          const puppeteer = require('puppeteer');

          async function generatePDF() {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();

            // Set styles for PDF generation
            await page.addStyleTag({
              content: `
                @page {
                  size: A4;
                  margin: 20mm 15mm;
                }
                body {
                  background: white !important;
                  color: black !important;
                  font-size: 12pt !important;
                }
                .nav-bar, .back-to-top, .download-resume-container, .footer {
                  display: none !important;
                }
                h1, h2, h3, h4, h5 {
                  color: black !important;
                }
                h1 {
                  -webkit-text-fill-color: black !important;
                  background: none !important;
                }
                .profile-subtitle {
                  color: #333 !important;
                }
                a {
                  color: #333 !important;
                  text-decoration: none !important;
                }
                .project-links, .github-actions-note {
                  display: none !important;
                }
                .tech-tag {
                  background-color: #f1f1f1 !important;
                  color: #333 !important;
                  border: 1px solid #ddd !important;
                }
                @media print {
                  html, body {
                    height: auto !important;
                  }
                }
              `
            });

            // Get the full path to the HTML file
            await page.goto('file://' + process.cwd() + '/resume.html', {
              waitUntil: 'networkidle0'
            });

            // Generate PDF
            await page.pdf({
              path: 'assets/pdf/GonzaloFernandez_Resume.pdf',
              format: 'A4',
              printBackground: true,
              displayHeaderFooter: true,
              headerTemplate: '<div></div>',
              footerTemplate: '<div style="width: 100%; text-align: center; font-size: 8px; color: #333;">Generated from patillacode.github.io | Page <span class="pageNumber"></span> of <span class="totalPages"></span></div>',
              margin: {
                top: '20mm',
                bottom: '20mm',
                left: '15mm',
                right: '15mm'
              }
            });

            await browser.close();
            console.log('PDF generated successfully!');
          }

          generatePDF().catch(err => {
            console.error('Error generating PDF:', err);
            process.exit(1);
          });
          EOL

          # Run the script
          node generate-pdf.js

      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add assets/pdf/GonzaloFernandez_Resume.pdf
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update resume PDF" && git push)
